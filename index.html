<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>三丽鸥家族 · 角色测试</title>
  <meta name="description" content="回答20道小问题，看看你更像哪位三丽鸥角色～支持生成分享链接。" />
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f6fbff;
      --card:#ffffff;
      --text:#1f1f24;
      --muted:#6a6a78;
      --primary:#ff5fa2;
      --primary2:#6a7bff;
      --border:#f0d9e6;
      --shadow: 0 14px 38px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 10%, var(--bg2), transparent 60%),
        radial-gradient(1000px 500px at 90% 0%, var(--bg1), transparent 65%),
        linear-gradient(180deg, #ffffff 0%, #fff7fb 40%, #f6fbff 100%);
      min-height:100vh;
    }
    .wrap{ max-width:760px; margin:0 auto; padding:22px 14px 64px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      margin: 2px 2px 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background:linear-gradient(135deg,var(--primary),#ffd1e6);
      box-shadow:0 10px 24px rgba(255,95,162,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px 10px 10px 9px;
      border-radius:9px;
      background:linear-gradient(135deg,#fff,#ffe8f2);
      opacity:.9;
    }
    .chip{
      font-size:12px; color:var(--muted);
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(6px);
    }

    .card{
      background:rgba(255,255,255,.86);
      border:1px solid rgba(240,217,230,.9);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    h1{ margin:0 0 6px; font-size:22px; }
    .sub{ color:var(--muted); font-size:14px; line-height:1.7; }
    .hide{ display:none !important; }

    .btn{
      width:100%;
      border:0;
      border-radius:16px;
      padding:14px 16px;
      background:linear-gradient(135deg,var(--primary),#ff86b8);
      color:#fff;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(255,95,162,.25);
      transition: transform .06s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background:rgba(255,255,255,.9);
      color:var(--primary);
      border:1px solid var(--border);
      box-shadow:none;
      font-weight:800;
    }
    .btn.ghost{
      background:transparent;
      color:var(--muted);
      border:1px dashed rgba(240,217,230,.9);
      box-shadow:none;
      font-weight:700;
    }

    .hero{
      display:flex; gap:14px; align-items:flex-start;
    }
    .hero .left{ flex:1; }
    .hero .right{
      width:250px; flex:0 0 250px;
      display:flex; flex-direction:column; gap:10px; align-items:center;
    }

    /* ✅ 放大：统一 220px */
    .badge{
      width:220px; height:220px;
      border-radius:999px;
      border:4px solid rgba(255,255,255,.95);
      box-shadow:0 16px 30px rgba(0,0,0,.10);
      background:#fff;
      overflow:hidden;
    }
    .badge img{ width:100%; height:100%; display:block; object-fit:cover; }

    .divider{ height:12px; }
    .row{ display:flex; gap:10px; margin-top:12px; }
    .row .btn{ flex:1; }

    .qhead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .progressWrap{
      width:100%;
      height:10px;
      background:rgba(240,217,230,.55);
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(240,217,230,.95);
      margin: 10px 0 14px;
    }
    .progressBar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--primary),#ffb2d0);
      border-radius:999px;
      transition: width .2s ease;
    }

    .question{ font-size:18px; font-weight:900; margin:8px 0 12px; }
    .opt{
      display:block;
      width:100%;
      text-align:left;
      padding:14px 14px;
      margin:10px 0;
      border-radius:16px;
      border:1px solid rgba(240,217,230,.95);
      background:rgba(255,255,255,.92);
      cursor:pointer;
      font-size:15px;
      line-height:1.45;
      transition: transform .06s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .opt:hover{
      border-color: rgba(255,156,197,.95);
      box-shadow: 0 10px 22px rgba(255,95,162,.10);
    }
    .opt.selected{
      border-color: rgba(255,95,162,.9);
      box-shadow: 0 12px 26px rgba(255,95,162,.14);
      transform: translateY(-1px);
    }

    .resultHeader{
      display:flex; gap:14px; align-items:center; justify-content:center;
      margin-bottom:10px;
    }
    .resultTitle{ font-size:20px; font-weight:1000; margin:0; }
    .tag{
      display:inline-block;
      margin:7px 7px 0 0;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(240,217,230,.95);
      font-size:12px;
      color:var(--muted);
    }
    .kv{
      text-align:left;
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(240,217,230,.95);
      background:rgba(255,255,255,.82);
    }
    .k{ font-weight:900; font-size:13px; color:#2a2a35; margin-bottom:6px; }
    .v{ color:var(--muted); font-size:14px; line-height:1.65; }
    .small{ font-size:12px; color:var(--muted); margin-top:10px; line-height:1.6; }
    .center{ text-align:center; }

    @media (max-width:520px){
      .hero{ flex-direction:column; }
      .hero .right{ width:100%; flex:1; flex-direction:row; justify-content:flex-start; }
      /* 手机端也放大一点 */
      .badge{ width:160px; height:160px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>三丽鸥家族 · 角色测试</div>
      </div>
      <div class="chip" id="topChip">20题 · 可分享</div>
    </div>

    <!-- 首页 -->
    <div id="home" class="card">
      <div class="hero">
        <div class="left">
          <h1>测测你更像哪位三丽鸥角色？</h1>
          <div class="sub">
            回答 20 道小问题，系统会给你一个“主角色”+“隐藏副人格”，并生成可分享链接。
          </div>
          <div class="divider"></div>
          <button class="btn" onclick="start()">开始测试</button>
          <div class="small">
          </div>
        </div>
        <div class="right">
          <div class="badge" title="可爱预览">
            <img id="previewImg" alt="preview" />
          </div>
          <div class="chip">打开就能玩</div>
        </div>
      </div>
    </div>

    <!-- 题目页 -->
    <div id="quiz" class="card hide">
      <div class="qhead">
        <div class="chip" id="progressText">第 1/20 题</div>
        <div class="chip" id="hint">选最像你的</div>
      </div>

      <div class="progressWrap"><div class="progressBar" id="progressBar"></div></div>

      <div class="question" id="qtext"></div>
      <div id="options"></div>

      <div class="row">
        <button class="btn secondary" onclick="prev()">上一题</button>
        <button class="btn" onclick="next()">下一题</button>
      </div>
      <div class="small">你可以随时返回修改答案，最终以提交时的选择为准。</div>
    </div>

    <!-- 结果页 -->
    <div id="result" class="card hide center">
      <div class="resultHeader">
        <!-- ✅ 放大结果页头像：220 -->
        <div class="badge" style="width:220px;height:220px;">
          <img id="rimg" alt="role" />
        </div>
        <div style="text-align:left">
          <div class="chip">你的主角色</div>
          <div class="resultTitle">✨ <span id="rname"></span></div>
          <div class="small" style="margin-top:6px;">隐藏副人格：<b id="subname"></b></div>
        </div>
      </div>

      <div class="sub" id="rdesc" style="text-align:left;"></div>

      <div style="height:10px"></div>
      <div id="rtags" style="text-align:left;"></div>

      <div class="kv">
        <div class="k">隐藏属性</div>
        <div class="v" id="rhidden"></div>
      </div>
      <div class="kv">
        <div class="k">最佳搭子</div>
        <div class="v" id="rbest"></div>
      </div>
      <div class="kv">
        <div class="k">雷点预警</div>
        <div class="v" id="ravoid"></div>
      </div>
      <div class="kv">
        <div class="k">充电方式</div>
        <div class="v" id="rrecharge"></div>
      </div>

      <div style="height:14px"></div>
      <button class="btn" onclick="copyLink()">复制结果链接</button>
      <div style="height:10px"></div>
      <button class="btn secondary" onclick="restart()">再测一次</button>
      <div style="height:8px"></div>
      <button class="btn ghost" onclick="shareNative()">系统分享（支持的设备）</button>

      <div class="small" id="linkTip"></div>
    </div>
  </div>

<script>
/** ====== 图片兜底占位（可爱占位图SVG） ====== */
function placeholderDataUrl(label="IMG"){
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="220" viewBox="0 0 220 220">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="#fff2f8"/>
        <stop offset="1" stop-color="#f0f7ff"/>
      </linearGradient>
      <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="8" stdDeviation="10" flood-color="#000" flood-opacity=".10"/>
      </filter>
    </defs>
    <rect width="220" height="220" rx="36" fill="url(#g)"/>
    <circle cx="110" cy="118" r="74" fill="#fff" opacity=".92" filter="url(#s)"/>
    <circle cx="84" cy="116" r="10" fill="#222" opacity=".75"/>
    <circle cx="136" cy="116" r="10" fill="#222" opacity=".75"/>
    <circle cx="110" cy="136" r="7" fill="#ff5fa2" opacity=".7"/>
    <path d="M88 150 C98 162, 122 162, 132 150" fill="none" stroke="#222" stroke-width="6" stroke-linecap="round" opacity=".5"/>
    <rect x="24" y="24" width="56" height="30" rx="14" fill="#fff" opacity=".8"/>
    <text x="52" y="44" text-anchor="middle" font-size="14" font-weight="800" fill="#ff5fa2">${label}</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
}

/** 给 <img> 设置 src，失败则用占位图 */
function setImgSafe(imgEl, src, label){
  imgEl.onerror = () => {
    imgEl.onerror = null;
    imgEl.src = placeholderDataUrl(label);
  };
  imgEl.src = src;
}

/** ====== 角色库（12个）— ✅ 最终：对应你仓库 images 文件夹的文件名 ====== */
const roles = {
  helloKitty: { name:"Hello Kitty", imageUrl:"./images/helloKitty.png",
    desc:"你给人的第一感觉是稳、体面、可靠。你擅长把生活打理得井井有条，也很会照顾别人的感受。",
    tags:["可靠稳重","边界感强","审美在线","稳定输出"], hidden:"安全感制造机", bestMatch:"Cinnamoroll / My Melody", avoid:"没礼貌、越界", recharge:"整理计划、热饮" },

  myMelody: { name:"My Melody", imageUrl:"./images/myMelody.png",
    desc:"温柔坚定型：共情力强，能治愈他人，也需要被好好对待。",
    tags:["治愈系","共情力强","温柔坚定","小幸福"], hidden:"情绪调音师", bestMatch:"Hello Kitty / Pompompurin", avoid:"冷暴力", recharge:"甜品、香薰" },

  kuromi: { name:"Kuromi", imageUrl:"./images/kuromi.png",
    desc:"酷酷的可爱：有主见敢表达，嘴硬心软，重情义。",
    tags:["反差萌","嘴硬心软","个性鲜明","行动派"], hidden:"战斗型浪漫", bestMatch:"Badtz-Maru / Hello Kitty", avoid:"控制欲强", recharge:"运动、短途出走" },

  cinnamoroll: { name:"Cinnamoroll（大耳狗）", imageUrl:"./images/cinnamoroll.png",
    desc:"像云朵一样轻松治愈：氛围感强，重视陪伴与安全感。",
    tags:["氛围组核心","乐观可爱","需要安全感","社交舒适"], hidden:"情绪缓冲垫", bestMatch:"Hello Kitty / Pochacco", avoid:"关系不确定", recharge:"睡饱、抱抱" },

  pompompurin: { name:"Pompompurin（布丁狗）", imageUrl:"./images/pompompurin.png",
    desc:"松弛感王者：好相处、懂享受，能把压力变温柔。",
    tags:["松弛感","好相处","享受生活","温和幽默"], hidden:"快乐扩散器", bestMatch:"My Melody / Cinnamoroll", avoid:"高压逼迫", recharge:"好好吃一顿、午睡" },

  pochacco: { name:"Pochacco（帕恰狗）", imageUrl:"./images/pochacco.png",
    desc:"活力派：爱探索、真诚仗义，能带动朋友一起行动。",
    tags:["活力值高","真诚仗义","爱探索","气氛担当"], hidden:"超强带动性", bestMatch:"Cinnamoroll / Keroppi", avoid:"扫兴", recharge:"运动、约朋友" },

  keroppi: { name:"Keroppi（可洛比）", imageUrl:"./images/keroppi.png",
    desc:"乐天行动型：点子多，复原力强，把困难当关卡。",
    tags:["乐天派","行动力","点子多","复原力强"], hidden:"困难消化器", bestMatch:"Pochacco / Hello Kitty", avoid:"过度悲观", recharge:"户外、音乐" },

  badtzMaru: { name:"Badtz-Maru（酷企鹅）", imageUrl:"./images/badtzMaru.png",
    desc:"独立清醒：不爱迎合，效率派，真诚又护短。",
    tags:["独立清醒","毒舌真诚","效率派","酷感审美"], hidden:"反套路智者", bestMatch:"Kuromi / Hello Kitty", avoid:"低效扯皮", recharge:"独处、听歌" },

  littleTwinStars: { name:"Little Twin Stars（双子星）", imageUrl:"./images/littleTwinStars.png",
    desc:"浪漫与想象力：审美强，爱把日子过成童话。",
    tags:["浪漫主义","想象力","审美强","温柔细腻"], hidden:"灵感捕手", bestMatch:"My Melody / Hello Kitty", avoid:"嘲笑梦想", recharge:"听歌、看展" },

  gudetama: { name:"Gudetama（蛋黄哥）", imageUrl:"./images/gudetama.png",
    desc:"省电清醒：拒绝无意义努力，擅长能量管理。",
    tags:["省电模式","清醒吐槽","怕麻烦","高效率"], hidden:"能量管理大师", bestMatch:"Pompompurin / Hello Kitty", avoid:"被催促", recharge:"睡觉、发呆" },

  hangyodon: { name:"Hangyodon（半鱼人）", imageUrl:"./images/hangyodon.png",
    desc:"搞笑外壳敏感内核：氛围雷达，真诚又共情。",
    tags:["搞笑担当","敏感细腻","反差感","共情强"], hidden:"氛围雷达", bestMatch:"Cinnamoroll / My Melody", avoid:"被忽视", recharge:"喜剧、热乎的" },

  tuxedosam: { name:"Tuxedosam（企鹅山姆）", imageUrl:"./images/tuxedosam.png",
    desc:"精致讲究：礼貌体面，审美挑剔但不矫情。",
    tags:["精致讲究","礼貌体面","审美挑剔","氛围控"], hidden:"场面调度者", bestMatch:"Hello Kitty / Twin Stars", avoid:"粗糙敷衍", recharge:"咖啡、仪式感" }
};

/** ====== 20题题库（与你原来一致） ====== */
const questions = [
  { q:"周末更想怎么过？", opts:[
    { t:"宅家追剧+点甜品，舒服最重要", score:{ gudetama:2, pompompurin:2, cinnamoroll:1 }},
    { t:"收拾房间/做计划，把生活整理好", score:{ helloKitty:2, tuxedosam:1 }},
    { t:"出去玩！新餐厅/新路线/新活动", score:{ pochacco:2, keroppi:2 }},
    { t:"去看展/拍照/找灵感，慢慢逛", score:{ littleTwinStars:2, myMelody:1, tuxedosam:1 }}
  ]},
  { q:"朋友临时约你出门，你：", opts:[
    { t:"看心情，今天电量够就去", score:{ gudetama:2, hangyodon:1 }},
    { t:"立刻答应：走！", score:{ pochacco:2, keroppi:1, cinnamoroll:1 }},
    { t:"先确认时间地点细节再决定", score:{ helloKitty:2, tuxedosam:1 }},
    { t:"嘴上嫌麻烦，但最后还是会去", score:{ badtzMaru:2, kuromi:1, hangyodon:1 }}
  ]},
  { q:"你最受不了哪种人？", opts:[
    { t:"没礼貌/越界/不尊重别人", score:{ helloKitty:2, tuxedosam:1 }},
    { t:"控制欲强、道德绑架、爱说教", score:{ kuromi:2, badtzMaru:2 }},
    { t:"忽冷忽热、冷暴力、不回应", score:{ myMelody:2, cinnamoroll:1, hangyodon:1 }},
    { t:"低效扯皮、无意义内耗", score:{ gudetama:2, badtzMaru:1 }}
  ]},
  { q:"压力大时你更像：", opts:[
    { t:"先把计划列出来，逐个解决", score:{ helloKitty:2, tuxedosam:1 }},
    { t:"找人聊聊，需要被安慰一下", score:{ myMelody:2, hangyodon:1 }},
    { t:"先冲一波，把问题狠狠干掉", score:{ kuromi:2, keroppi:1 }},
    { t:"先躺会儿，等电量恢复再说", score:{ gudetama:2, pompompurin:1 }}
  ]},
  { q:"你在朋友群里通常负责：", opts:[
    { t:"定计划/控节奏/把事情推进", score:{ helloKitty:2 }},
    { t:"活跃气氛/讲笑话/缓解尴尬", score:{ cinnamoroll:2, hangyodon:2 }},
    { t:"提出新点子/拉大家去冒险", score:{ keroppi:2, pochacco:1 }},
    { t:"吐槽输出/指出不合理/当清醒的人", score:{ badtzMaru:2, kuromi:1, gudetama:1 }}
  ]},
  { q:"你更在意别人怎么看你？", opts:[
    { t:"可靠、有分寸、让人放心", score:{ helloKitty:2, tuxedosam:1 }},
    { t:"可爱、温柔、好相处", score:{ myMelody:2, cinnamoroll:1, pompompurin:1 }},
    { t:"有个性、不随波逐流", score:{ kuromi:2, badtzMaru:1 }},
    { t:"别烦我，我只想省点力", score:{ gudetama:2 }}
  ]},
  { q:"如果必须加班，你会：", opts:[
    { t:"先安排流程，提高效率，早点结束", score:{ badtzMaru:2, helloKitty:1, gudetama:1 }},
    { t:"默默做完，但会照顾好大家情绪", score:{ myMelody:2, helloKitty:1 }},
    { t:"情绪上头：为什么要加班！但还是会搞定", score:{ kuromi:2, hangyodon:1 }},
    { t:"能拖就拖，能省就省，绝不硬扛", score:{ gudetama:2, pompompurin:1 }}
  ]},
  { q:"你对“仪式感”的态度：", opts:[
    { t:"很重要！生活要过得漂亮", score:{ tuxedosam:2, helloKitty:1, littleTwinStars:1 }},
    { t:"可有可无，但可爱就加分", score:{ myMelody:2, cinnamoroll:1 }},
    { t:"我只要舒服省事就行", score:{ gudetama:2, pompompurin:1 }},
    { t:"看心情，想酷的时候就来一套", score:{ kuromi:2, badtzMaru:1 }}
  ]},
  { q:"你更像哪种恋爱/关系模式？", opts:[
    { t:"稳稳的陪伴型，细水长流", score:{ helloKitty:2, pompompurin:1 }},
    { t:"温柔黏人一点，需要回应和确认", score:{ myMelody:2, cinnamoroll:1 }},
    { t:"又甜又酷，嘴硬心软但很护短", score:{ kuromi:2, hangyodon:1 }},
    { t:"保持空间，别太黏，轻松就好", score:{ gudetama:2, badtzMaru:1 }}
  ]},
  { q:"看到别人难过，你通常：", opts:[
    { t:"先陪着，听完再安慰", score:{ myMelody:2, cinnamoroll:1 }},
    { t:"给出可执行的解决方案", score:{ helloKitty:2, badtzMaru:1 }},
    { t:"用搞笑把人逗笑，让气氛轻一点", score:{ hangyodon:2, pochacco:1 }},
    { t:"表面冷，但会偷偷帮忙", score:{ badtzMaru:2, kuromi:1 }}
  ]},
  { q:"你做决定更偏向：", opts:[
    { t:"理性权衡：利弊/风险/时间", score:{ helloKitty:2, badtzMaru:1 }},
    { t:"凭直觉：我觉得这样更对", score:{ kuromi:2, keroppi:1 }},
    { t:"考虑他人感受：别让人尴尬或受伤", score:{ myMelody:2, tuxedosam:1 }},
    { t:"能不决定就不决定，先放着", score:{ gudetama:2, littleTwinStars:1 }}
  ]},
  { q:"你最喜欢的夸奖是：", opts:[
    { t:"你真的很靠谱", score:{ helloKitty:2 }},
    { t:"和你在一起很舒服/被治愈", score:{ cinnamoroll:2, myMelody:2, pompompurin:1 }},
    { t:"你真的很酷/很有个性", score:{ kuromi:2, badtzMaru:1 }},
    { t:"你太会生活/太有品味了", score:{ tuxedosam:2, littleTwinStars:1 }}
  ]},
  { q:"你更像哪种“社交电量”？", opts:[
    { t:"社交会消耗我，得经常独处充电", score:{ gudetama:2, badtzMaru:1, littleTwinStars:1 }},
    { t:"有熟人就很放松，陌生人会紧张", score:{ myMelody:2, hangyodon:1 }},
    { t:"越热闹越兴奋，我能带动全场", score:{ pochacco:2, cinnamoroll:1, keroppi:1 }},
    { t:"我不爱热闹，但我能把场面撑住", score:{ helloKitty:2, tuxedosam:1 }}
  ]},
  { q:"对“买东西”的态度：", opts:[
    { t:"买品质/买审美/买氛围", score:{ tuxedosam:2, littleTwinStars:1, helloKitty:1 }},
    { t:"买可爱/买治愈/看到就想要", score:{ myMelody:2, cinnamoroll:1 }},
    { t:"买酷的/独特的/有态度的", score:{ kuromi:2, badtzMaru:1 }},
    { t:"能不买就不买，省事省钱", score:{ gudetama:2, pompompurin:1 }}
  ]},
  { q:"你遇到冲突时更常：", opts:[
    { t:"尽量不吵，先让大家冷静", score:{ myMelody:2, cinnamoroll:1 }},
    { t:"直说：不爽就要讲清楚", score:{ kuromi:2, badtzMaru:1 }},
    { t:"用幽默转移火力，先降温", score:{ hangyodon:2, pompompurin:1 }},
    { t:"讲规则讲边界，按流程解决", score:{ helloKitty:2, tuxedosam:1 }}
  ]},
  { q:"你最常掉进哪种内耗？", opts:[
    { t:"担心自己不够好/别人不喜欢我", score:{ myMelody:2, hangyodon:1 }},
    { t:"想得太美/太理想，迟迟不动手", score:{ littleTwinStars:2 }},
    { t:"嫌麻烦，不想开始就一直拖", score:{ gudetama:2 }},
    { t:"不服输：我一定要赢/要证明", score:{ kuromi:2, badtzMaru:1 }}
  ]},
  { q:"你更像哪种工作/学习风格？", opts:[
    { t:"稳扎稳打，按计划推进", score:{ helloKitty:2 }},
    { t:"灵感来了爆发，没灵感就摆", score:{ littleTwinStars:2, gudetama:1 }},
    { t:"喜欢快节奏与挑战，边做边优化", score:{ keroppi:2, kuromi:1 }},
    { t:"效率至上，讨厌形式主义", score:{ badtzMaru:2, gudetama:1 }}
  ]},
  { q:"你最向往的生活氛围：", opts:[
    { t:"干净整洁、稳定、可持续", score:{ helloKitty:2 }},
    { t:"柔软温暖、有人陪、慢慢来", score:{ myMelody:2, cinnamoroll:1, pompompurin:1 }},
    { t:"酷一点自由一点，想走就走", score:{ kuromi:2, badtzMaru:1, pochacco:1 }},
    { t:"好看好听好闻，像童话一样", score:{ littleTwinStars:2, tuxedosam:1 }}
  ]},
  { q:"朋友说你“太___了”，最像哪句？", opts:[
    { t:"太会照顾别人了", score:{ myMelody:2, helloKitty:1 }},
    { t:"太能扛、太靠谱了", score:{ helloKitty:2 }},
    { t:"太会吐槽但又很真了", score:{ badtzMaru:2, kuromi:1, gudetama:1 }},
    { t:"太可爱/太会活跃气氛了", score:{ cinnamoroll:2, hangyodon:1, pochacco:1 }}
  ]},
  { q:"最后一题：你给自己的关键词更像：", opts:[
    { t:"#稳定输出 #有分寸", score:{ helloKitty:2, tuxedosam:1 }},
    { t:"#温柔坚定 #治愈", score:{ myMelody:2, cinnamoroll:1 }},
    { t:"#酷但可爱 #不服输", score:{ kuromi:2, badtzMaru:1 }},
    { t:"#省电模式 #别催我", score:{ gudetama:2, pompompurin:1 }}
  ]}
];

/** ====== 状态 ====== */
let idx = 0;
let answers = Array(questions.length).fill(null);
let scores = {};
const roleKeys = Object.keys(roles);

function resetScores(){ scores={}; roleKeys.forEach(k=>scores[k]=0); }
function initPreview(){
  const pick = roleKeys[Math.floor(Math.random() * roleKeys.length)];
  setImgSafe(document.getElementById("previewImg"), roles[pick].imageUrl, pick.toUpperCase().slice(0,3));
}

function start(){
  document.getElementById('home').classList.add('hide');
  document.getElementById('quiz').classList.remove('hide');
  document.getElementById('result').classList.add('hide');
  idx=0;
  answers = Array(questions.length).fill(null);
  resetScores();
  render();
}

function render(){
  const q = questions[idx];
  document.getElementById('progressText').innerText = `第 ${idx+1}/${questions.length} 题`;
  document.getElementById('qtext').innerText = q.q;

  const pct = Math.round((idx) / (questions.length) * 100);
  document.getElementById('progressBar').style.width = `${pct}%`;

  const box = document.getElementById('options');
  box.innerHTML = "";
  q.opts.forEach((o, i)=>{
    const btn = document.createElement('button');
    btn.className = "opt" + (answers[idx]===i ? " selected" : "");
    btn.type = "button";
    btn.innerText = o.t;
    btn.onclick = ()=>choose(i);
    box.appendChild(btn);
  });
}

function choose(i){ answers[idx]=i; render(); }
function prev(){ if(idx>0){ idx--; render(); } }

function next(){
  if(answers[idx] === null){
    alert("请选择一个选项～");
    return;
  }
  if(idx < questions.length - 1){
    idx++;
    render();
  }else{
    calc();
    showResult();
  }
}

function calc(){
  resetScores();
  questions.forEach((qq, qi)=>{
    const pick = answers[qi];
    const sc = qq.opts[pick].score || {};
    Object.keys(sc).forEach(k=>{
      if(scores[k] === undefined) scores[k] = 0;
      scores[k] += sc[k];
    });
  });
}

function pickMainAndSub(){
  const max = Math.max(...Object.values(scores));
  const tied = Object.keys(scores).filter(k => scores[k] === max);
  const mainKey = tied[Math.floor(Math.random() * tied.length)];

  const sorted = Object.keys(scores).sort((a,b)=>scores[b]-scores[a]);
  let subKey = sorted[0] === mainKey ? sorted[1] : sorted[0];
  if(!subKey) subKey = mainKey;

  return { mainKey, subKey };
}

function pickSubFromMain(mainKey){
  const map = {
    helloKitty:"tuxedosam",
    myMelody:"cinnamoroll",
    kuromi:"badtzMaru",
    cinnamoroll:"pompompurin",
    pompompurin:"gudetama",
    pochacco:"keroppi",
    keroppi:"pochacco",
    badtzMaru:"gudetama",
    littleTwinStars:"tuxedosam",
    gudetama:"pompompurin",
    hangyodon:"myMelody",
    tuxedosam:"helloKitty"
  };
  return map[mainKey] || mainKey;
}

function showResult(mainKeyOverride=null, subKeyOverride=null){
  document.getElementById('quiz').classList.add('hide');
  document.getElementById('home').classList.add('hide');
  document.getElementById('result').classList.remove('hide');

  let mainKey, subKey;
  if(mainKeyOverride && roles[mainKeyOverride]){
    mainKey = mainKeyOverride;
    subKey = (subKeyOverride && roles[subKeyOverride]) ? subKeyOverride : pickSubFromMain(mainKey);
  }else{
    ({ mainKey, subKey } = pickMainAndSub());
  }

  location.hash = `#r=${encodeURIComponent(mainKey)}&s=${encodeURIComponent(subKey)}`;

  const role = roles[mainKey];
  document.getElementById('rname').innerText = role.name;
  setImgSafe(document.getElementById('rimg'), role.imageUrl, mainKey.toUpperCase().slice(0,3));

  document.getElementById('rdesc').innerText = role.desc;
  document.getElementById('rhidden').innerText = role.hidden;
  document.getElementById('rbest').innerText = role.bestMatch;
  document.getElementById('ravoid').innerText = role.avoid;
  document.getElementById('rrecharge').innerText = role.recharge;

  const subRole = roles[subKey];
  document.getElementById('subname').innerText = subRole ? subRole.name : role.name;

  const tagsBox = document.getElementById('rtags');
  tagsBox.innerHTML = "";
  role.tags.forEach(t=>{
    const span = document.createElement('span');
    span.className = "tag";
    span.innerText = t;
    tagsBox.appendChild(span);
  });

  document.getElementById('linkTip').innerText = "";
}

function copyLink(){
  const url = location.href;
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(url).then(()=>{
      document.getElementById('linkTip').innerText = "已复制！把链接发给朋友，他们打开就能直接看到你的结果～";
    }).catch(()=>fallbackCopy(url));
  }else{
    fallbackCopy(url);
  }
}

function fallbackCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  try{
    document.execCommand('copy');
    document.getElementById('linkTip').innerText = "已复制！把链接发给朋友就行～";
  }catch(e){
    document.getElementById('linkTip').innerText = "复制失败：请手动复制地址栏链接。";
  }
  document.body.removeChild(ta);
}

async function shareNative(){
  const url = location.href;
  const title = "三丽鸥家族 · 角色测试";
  const text = `我测出来是：${document.getElementById('rname').innerText}（隐藏副人格：${document.getElementById('subname').innerText}）`;
  if(navigator.share){
    try{
      await navigator.share({ title, text, url });
      document.getElementById('linkTip').innerText = "已调起系统分享～";
    }catch(e){}
  }else{
    document.getElementById('linkTip').innerText = "当前设备不支持系统分享，可以用“复制结果链接”。";
  }
}

function restart(){
  location.hash = "";
  document.getElementById('result').classList.add('hide');
  document.getElementById('quiz').classList.add('hide');
  document.getElementById('home').classList.remove('hide');
  document.getElementById('linkTip').innerText = "";
  initPreview();
}

/** ====== Hash 解析（分享链接直接展示结果） ====== */
function parseHash(){
  const h = (location.hash || "").replace(/^#/, "");
  if(!h) return {};
  const parts = h.split("&").map(s=>s.trim()).filter(Boolean);
  const obj = {};
  parts.forEach(p=>{
    const [k,v] = p.split("=");
    if(!k) return;
    obj[decodeURIComponent(k)] = decodeURIComponent(v || "");
  });
  return obj;
}

window.addEventListener('load', ()=>{
  initPreview();
  const { r, s } = parseHash();
  if(r && roles[r]){
    showResult(r, s);
  }
});

window.addEventListener('hashchange', ()=>{
  const { r, s } = parseHash();
  if(r && roles[r]){
    showResult(r, s);
  }
});
</script>
</body>
</html>

